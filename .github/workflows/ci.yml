name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  validate-migrations:
    name: Validar Compilación de CLIs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        run: |
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Instalar Go 1.25
        run: |
          wget -q https://go.dev/dl/go1.25.0.linux-amd64.tar.gz
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf go1.25.0.linux-amd64.tar.gz
          echo "/usr/local/go/bin" >> $GITHUB_PATH
          export PATH=$PATH:/usr/local/go/bin
          go version

      - name: Configurar Git para repos privados
        run: |
          git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
        env:
          GOPRIVATE: github.com/EduGoGroup/*

      - name: Validar compilación - PostgreSQL
        run: |
          cd postgres
          export PATH=$PATH:/usr/local/go/bin
          go mod download
          go build ./cmd/migrate
          go build ./cmd/runner
          echo "✅ PostgreSQL CLIs compilan correctamente"

      - name: Validar compilación - MongoDB
        run: |
          cd mongodb
          export PATH=$PATH:/usr/local/go/bin
          go mod download
          go build ./cmd/migrate
          echo "✅ MongoDB CLIs compilan correctamente"

      - name: Validar sintaxis SQL
        run: |
          echo "ℹ️ Validación de sintaxis SQL - revisar manualmente archivos .sql"
          echo "ℹ️ Tests de integración se ejecutan localmente con ENABLE_INTEGRATION_TESTS=true"

  test-modules:
    name: Tests Unitarios
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        run: |
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Instalar Go 1.25
        run: |
          wget -q https://go.dev/dl/go1.25.0.linux-amd64.tar.gz
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf go1.25.0.linux-amd64.tar.gz
          echo "/usr/local/go/bin" >> $GITHUB_PATH
          export PATH=$PATH:/usr/local/go/bin
          go version

      - name: Configurar Git para repos privados
        run: |
          git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
        env:
          GOPRIVATE: github.com/EduGoGroup/*

      - name: Tests - PostgreSQL
        run: |
          cd postgres
          export PATH=$PATH:/usr/local/go/bin
          go mod download
          go test -short -race -v ./...
          echo "✅ Tests PostgreSQL completados"

      - name: Tests - MongoDB
        run: |
          cd mongodb
          export PATH=$PATH:/usr/local/go/bin
          go mod download
          go test -short -race -v ./...
          echo "✅ Tests MongoDB completados"

      - name: Tests - Schemas
        run: |
          cd schemas
          export PATH=$PATH:/usr/local/go/bin
          go mod download
          go test -short -race -v ./...
          echo "✅ Tests Schemas completados"

# Nota: Lint se ejecuta localmente con 'golangci-lint run'
# No requiere configuración en CI durante fase de desarrollo
