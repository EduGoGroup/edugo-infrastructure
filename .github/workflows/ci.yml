name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  validate-migrations:
    name: Validar Sintaxis SQL y Compilación
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-go@v6
        with:
          go-version: "1.25"
          cache: true

      - name: Configure Git for private repos
        run: |
          git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
        env:
          GOPRIVATE: github.com/EduGoGroup/*

      - name: Validar compilación de comandos
        run: |
          cd postgres
          go mod download
          go build ./cmd/migrate
          go build ./cmd/runner
          echo "✅ PostgreSQL CLIs compilan correctamente"

          cd ../mongodb
          go mod download
          go build ./cmd/migrate
          echo "✅ MongoDB CLIs compilan correctamente"

      - name: Validar sintaxis SQL
        run: |
          echo "ℹ️ Validación de sintaxis SQL - revisar manualmente archivos .sql"
          echo "ℹ️ Tests de integración se ejecutan localmente con ENABLE_INTEGRATION_TESTS=true"

  lint-modules:
    name: Lint de Módulos Go
    runs-on: ubuntu-latest
    if: false # Temporalmente deshabilitado - requiere configuración de permisos de org

    strategy:
      matrix:
        module: [postgres, mongodb, schemas]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: true

      - name: Configure Git for private repos
        run: |
          git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
        env:
          GOPRIVATE: github.com/EduGoGroup/*

      - name: Download dependencies
        working-directory: ${{ matrix.module }}
        run: |
          go mod download
          go mod verify

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: ${{ matrix.module }}
          args: --timeout=5m

  test-modules:
    name: Tests de Módulos Go
    runs-on: ubuntu-latest

    strategy:
      matrix:
        module: [postgres, mongodb, schemas]

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-go@v6
        with:
          go-version: "1.25"
          cache: true

      - name: Configure Git for private repos
        run: |
          git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
        env:
          GOPRIVATE: github.com/EduGoGroup/*

      - name: Run tests
        run: |
          cd ${{ matrix.module }}
          go mod download
          go test -short -race -v ./...
