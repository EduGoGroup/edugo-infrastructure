name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  # ===================
  # Validar Migraciones SQL
  # ===================
  validate-migrations:
    name: Validar Migraciones SQL
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: edugo_test
          POSTGRES_USER: edugo
          POSTGRES_PASSWORD: test123
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Validar sintaxis SQL
        run: |
          echo "üîç Validando sintaxis de archivos SQL..."
          for file in database/migrations/postgres/*.up.sql; do
            echo "Validando: $file"
            # Verificar que el archivo no est√° vac√≠o
            if [ ! -s "$file" ]; then
              echo "‚ùå Archivo vac√≠o: $file"
              exit 1
            fi
            echo "‚úÖ $file"
          done
      
      - name: Ejecutar migraciones UP
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: edugo_test
          DB_USER: edugo
          DB_PASSWORD: test123
          DB_SSL_MODE: disable
        run: |
          cd database
          go mod download
          echo "üìä Ejecutando migraciones..."
          go run migrate.go up
      
      - name: Verificar tablas creadas
        env:
          PGPASSWORD: test123
        run: |
          echo "üîç Verificando que tablas fueron creadas..."
          psql -h localhost -U edugo -d edugo_test -c "\dt" | grep users || exit 1
          psql -h localhost -U edugo -d edugo_test -c "\dt" | grep schools || exit 1
          psql -h localhost -U edugo -d edugo_test -c "\dt" | grep materials || exit 1
          psql -h localhost -U edugo -d edugo_test -c "\dt" | grep assessment || exit 1
          echo "‚úÖ Todas las tablas creadas correctamente"
      
      - name: Ejecutar migraciones DOWN
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: edugo_test
          DB_USER: edugo
          DB_PASSWORD: test123
          DB_SSL_MODE: disable
        run: |
          cd database
          echo "‚¨áÔ∏è Revirtiendo migraciones..."
          # Revertir todas (8 veces)
          for i in {1..8}; do
            go run migrate.go down || true
          done
          echo "‚úÖ Migraciones revertidas"

  # ===================
  # Tests de M√≥dulos Go
  # ===================
  test-modules:
    name: Tests de M√≥dulos Go
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        module: [database, schemas]
        go-version: ['1.24']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
      
      - name: Download dependencies
        run: |
          cd ${{ matrix.module }}
          go mod download
      
      - name: Run tests
        run: |
          cd ${{ matrix.module }}
          go test -v -race -coverprofile=coverage.out ./...
      
      - name: Check coverage
        run: |
          cd ${{ matrix.module }}
          go tool cover -func=coverage.out

  # ===================
  # Validar Docker Compose
  # ===================
  validate-docker:
    name: Validar Docker Compose
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validar sintaxis docker-compose
        run: |
          cd docker
          docker-compose config > /dev/null
          echo "‚úÖ docker-compose.yml es v√°lido"
      
      - name: Levantar servicios core
        run: |
          cd docker
          docker-compose up -d postgres mongodb
          sleep 10
      
      - name: Verificar servicios
        run: |
          docker ps
          docker-compose -f docker/docker-compose.yml ps postgres | grep "Up" || exit 1
          docker-compose -f docker/docker-compose.yml ps mongodb | grep "Up" || exit 1
          echo "‚úÖ Servicios core funcionando"
      
      - name: Limpiar
        run: |
          cd docker
          docker-compose down -v

  # ===================
  # Validar JSON Schemas
  # ===================
  validate-schemas:
    name: Validar JSON Schemas
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js (para validador de schemas)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Instalar ajv-cli
        run: npm install -g ajv-cli
      
      - name: Validar schemas
        run: |
          echo "üîç Validando JSON Schemas..."
          for schema in schemas/events/*.schema.json; do
            echo "Validando: $schema"
            ajv compile -s "$schema" || exit 1
            echo "‚úÖ $(basename $schema)"
          done
          echo "‚úÖ Todos los schemas son v√°lidos"

  # ===================
  # Lint y Formato
  # ===================
  lint:
    name: Lint y Formato
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: golangci-lint (database)
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: database
          args: --timeout=5m
      
      - name: golangci-lint (schemas)
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: schemas
          args: --timeout=5m
      
      - name: Verificar formato
        run: |
          cd database && test -z "$(gofmt -l .)" || (echo "C√≥digo no formateado en database/" && exit 1)
          cd ../schemas && test -z "$(gofmt -l .)" || (echo "C√≥digo no formateado en schemas/" && exit 1)
          echo "‚úÖ C√≥digo formateado correctamente"
