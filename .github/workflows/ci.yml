name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  validate-migrations:
    name: Validar Sintaxis SQL y Compilación
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-go@v6
        with:
          go-version: "1.24"

      - name: Validar compilación de comandos
        run: |
          cd postgres
          go mod download
          go build ./cmd/migrate
          go build ./cmd/runner
          echo "✅ PostgreSQL CLIs compilan correctamente"

          cd ../mongodb
          go mod download
          go build ./cmd/migrate
          go build ./migrations/cmd/runner
          echo "✅ MongoDB CLIs compilan correctamente"

      - name: Validar sintaxis SQL
        run: |
          echo "ℹ️ Validación de sintaxis SQL - revisar manualmente archivos .sql"
          echo "ℹ️ Tests de integración se ejecutan localmente con ENABLE_INTEGRATION_TESTS=true"

  test-modules:
    name: Tests de Módulos Go
    runs-on: ubuntu-latest

    strategy:
      matrix:
        module: [postgres, mongodb, messaging, schemas]

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-go@v6
        with:
          go-version: "1.24"

      - name: Run tests
        run: |
          cd ${{ matrix.module }}
          go mod download
          go test -v ./...
