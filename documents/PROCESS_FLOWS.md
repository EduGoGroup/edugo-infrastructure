# ğŸ”„ Process Flows - EduGo

Diagramas de secuencia detallados de los procesos principales del sistema.

---

## ğŸ“‹ Ãndice de Procesos

| Proceso | Actores | DescripciÃ³n |
|---------|---------|-------------|
| [Subida de Material](#1-subida-de-material) | Teacher, api-mobile, worker | Docente sube material y se genera quiz |
| [Toma de Assessment](#2-toma-de-assessment) | Student, api-mobile | Estudiante resuelve quiz |
| [MatrÃ­cula de Estudiante](#3-matrÃ­cula-de-estudiante) | Admin, api-admin, api-mobile | Admin matricula estudiante |
| [AutenticaciÃ³n](#4-autenticaciÃ³n) | User, API | Login y refresh de tokens |
| [EliminaciÃ³n de Material](#5-eliminaciÃ³n-de-material) | Teacher, api-mobile, worker | Docente elimina material |

---

## 1. Subida de Material

### Diagrama de Secuencia

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Teacher â”‚     â”‚ api-mobileâ”‚     â”‚  AWS S3 â”‚     â”‚ PostgreSQL â”‚     â”‚ RabbitMQ â”‚     â”‚ Worker â”‚     â”‚ MongoDB â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚ 1. Upload PDF  â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚ 2. Upload file â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚ 3. Return URL  â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚ 4. INSERT material (status='uploaded')           â”‚               â”‚               â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚ 5. Return material_id            â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚ 6. Publish 'material.uploaded'   â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚               â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚ 7. 201 Created â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚ 8. Consume event               â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚                â”‚ 9. Download PDF â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚ 10. UPDATE status='processing' â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚ 11. Call GPT-4
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚ 12. Generate quiz
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚ 13. INSERT assessment
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚ 14. UPDATE status='ready' + mongo_id          â”‚
     â”‚                â”‚                â”‚                 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚ 15. Publish 'assessment.generated'            â”‚
     â”‚                â”‚                â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚               â”‚               â”‚
     â”‚                â”‚                â”‚                 â”‚                â”‚               â”‚               â”‚
```

### Estados del Material

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ uploaded â”‚â”€â”€â”€â”€â–¶â”‚ processing â”‚â”€â”€â”€â”€â–¶â”‚  ready  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ failed  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Datos Creados

| Base de Datos | Tabla/Collection | AcciÃ³n |
|---------------|------------------|--------|
| PostgreSQL | `materials` | INSERT (status: uploaded â†’ processing â†’ ready) |
| PostgreSQL | `assessment` | INSERT (metadata + mongo_document_id) |
| MongoDB | `material_assessment_worker` | INSERT (preguntas completas) |
| MongoDB | `material_summary` | INSERT (resumen) |
| MongoDB | `material_event` | INSERT (log de evento) |

---

## 2. Toma de Assessment

### Diagrama de Secuencia

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Student â”‚     â”‚ api-mobileâ”‚     â”‚ PostgreSQL â”‚     â”‚ MongoDB â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                â”‚                  â”‚                â”‚
     â”‚ 1. GET /assessments/:id           â”‚                â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚                â”‚
     â”‚                â”‚                  â”‚                â”‚
     â”‚                â”‚ 2. SELECT assessment WHERE id=:id â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
     â”‚                â”‚                  â”‚                â”‚
     â”‚                â”‚ 3. Return assessment (mongo_document_id)          â”‚
     â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
     â”‚                â”‚                  â”‚                â”‚
     â”‚                â”‚ 4. findOne({_id: mongo_document_id})              â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                â”‚                  â”‚                â”‚
     â”‚                â”‚ 5. Return questions               â”‚
     â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                â”‚                  â”‚                â”‚
     â”‚ 6. 200 OK (assessment + questions)â”‚                â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚                â”‚
     â”‚                â”‚                  â”‚                â”‚
     â”‚ 7. POST /assessments/:id/start    â”‚                â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚                â”‚
     â”‚                â”‚                  â”‚                â”‚
     â”‚                â”‚ 8. INSERT assessment_attempt      â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
     â”‚                â”‚                  â”‚                â”‚
     â”‚ 9. 201 Created (attempt_id)       â”‚                â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚                â”‚
     â”‚                â”‚                  â”‚                â”‚
     â”‚     [Por cada pregunta respondida]â”‚                â”‚
     â”‚                â”‚                  â”‚                â”‚
     â”‚ 10. POST /attempts/:id/answer     â”‚                â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚                â”‚
     â”‚                â”‚                  â”‚                â”‚
     â”‚                â”‚ 11. INSERT assessment_attempt_answer               â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
     â”‚                â”‚                  â”‚                â”‚
     â”‚ 12. 201 OK     â”‚                  â”‚                â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚                â”‚
     â”‚                â”‚                  â”‚                â”‚
     â”‚     [Fin de preguntas]            â”‚                â”‚
     â”‚                â”‚                  â”‚                â”‚
     â”‚ 13. POST /attempts/:id/submit     â”‚                â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚                â”‚
     â”‚                â”‚                  â”‚                â”‚
     â”‚                â”‚ 14. SELECT all answers            â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
     â”‚                â”‚                  â”‚                â”‚
     â”‚                â”‚ 15. findOne (correct_answers)     â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                â”‚                  â”‚                â”‚
     â”‚                â”‚ 16. Calculate score               â”‚
     â”‚                â”‚ 17. UPDATE attempt (score, status='graded')        â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
     â”‚                â”‚                  â”‚                â”‚
     â”‚ 18. 200 OK (score, results)       â”‚                â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚                â”‚
```

### Datos Creados

| Tabla | AcciÃ³n | Campos Clave |
|-------|--------|--------------|
| `assessment_attempt` | INSERT | student_id, assessment_id, started_at, status |
| `assessment_attempt_answer` | INSERT (mÃºltiples) | attempt_id, question_index, student_answer |
| `assessment_attempt` | UPDATE | submitted_at, score, status='graded' |

### CÃ¡lculo de Score

```go
func calculateScore(answers []Answer, correctAnswers map[int]string) float64 {
    correct := 0
    for _, answer := range answers {
        if correctAnswers[answer.QuestionIndex] == answer.StudentAnswer {
            correct++
            answer.IsCorrect = true
        }
    }
    return float64(correct) / float64(len(correctAnswers)) * 100
}
```

---

## 3. MatrÃ­cula de Estudiante

### Diagrama de Secuencia

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Admin â”‚     â”‚api-administracionâ”‚     â”‚ PostgreSQL â”‚     â”‚ RabbitMQ â”‚     â”‚ api-mobileâ”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚                  â”‚                     â”‚                â”‚                 â”‚
    â”‚ 1. POST /memberships                   â”‚                â”‚                 â”‚
    â”‚ {student_id, school_id, academic_unit_id}               â”‚                 â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                     â”‚                â”‚                 â”‚
    â”‚                  â”‚                     â”‚                â”‚                 â”‚
    â”‚                  â”‚ 2. Validate student exists           â”‚                 â”‚
    â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                 â”‚
    â”‚                  â”‚                     â”‚                â”‚                 â”‚
    â”‚                  â”‚ 3. Validate school exists            â”‚                 â”‚
    â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                 â”‚
    â”‚                  â”‚                     â”‚                â”‚                 â”‚
    â”‚                  â”‚ 4. Validate academic_unit exists     â”‚                 â”‚
    â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                 â”‚
    â”‚                  â”‚                     â”‚                â”‚                 â”‚
    â”‚                  â”‚ 5. Check duplicate membership        â”‚                 â”‚
    â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                 â”‚
    â”‚                  â”‚                     â”‚                â”‚                 â”‚
    â”‚                  â”‚ 6. INSERT membership                 â”‚                 â”‚
    â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚                 â”‚
    â”‚                  â”‚                     â”‚                â”‚                 â”‚
    â”‚                  â”‚ 7. Publish 'student.enrolled'        â”‚                 â”‚
    â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚
    â”‚                  â”‚                     â”‚                â”‚                 â”‚
    â”‚ 8. 201 Created   â”‚                     â”‚                â”‚                 â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                â”‚                 â”‚
    â”‚                  â”‚                     â”‚                â”‚                 â”‚
    â”‚                  â”‚                     â”‚ 9. Consume event                 â”‚
    â”‚                  â”‚                     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                  â”‚                     â”‚                â”‚                 â”‚
    â”‚                  â”‚                     â”‚                â”‚ 10. Update cache/notify
    â”‚                  â”‚                     â”‚                â”‚                 â”‚
```

### Validaciones

1. **Usuario existe** y tiene rol `student`
2. **Escuela existe** y estÃ¡ activa
3. **Unidad acadÃ©mica existe** y pertenece a la escuela
4. **No existe membership duplicada** para user+school

### Datos Creados

| Tabla | AcciÃ³n | Campos Clave |
|-------|--------|--------------|
| `memberships` | INSERT | user_id, school_id, academic_unit_id, role='student', enrolled_at |

---

## 4. AutenticaciÃ³n

### Diagrama de Secuencia - Login

```
â”Œâ”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”‚ User â”‚     â”‚   API   â”‚     â”‚ PostgreSQL â”‚     â”‚ Redis â”‚
â””â”€â”€â”€â”¬â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”˜
    â”‚             â”‚                 â”‚               â”‚
    â”‚ 1. POST /auth/login           â”‚               â”‚
    â”‚ {email, password}             â”‚               â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚               â”‚
    â”‚             â”‚                 â”‚               â”‚
    â”‚             â”‚ 2. SELECT user WHERE email=:email               â”‚
    â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚               â”‚
    â”‚             â”‚                 â”‚               â”‚
    â”‚             â”‚ 3. Return user (password_hash) â”‚
    â”‚             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
    â”‚             â”‚                 â”‚               â”‚
    â”‚             â”‚ 4. bcrypt.Compare(password, hash)               â”‚
    â”‚             â”‚                 â”‚               â”‚
    â”‚             â”‚ 5. Generate JWT access_token (15min)            â”‚
    â”‚             â”‚                 â”‚               â”‚
    â”‚             â”‚ 6. Generate JWT refresh_token (7d)              â”‚
    â”‚             â”‚                 â”‚               â”‚
    â”‚             â”‚ 7. Store refresh_token          â”‚               â”‚
    â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚             â”‚                 â”‚               â”‚
    â”‚ 8. 200 OK   â”‚                 â”‚               â”‚
    â”‚ {access_token, refresh_token} â”‚               â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚               â”‚
```

### Diagrama de Secuencia - Refresh Token

```
â”Œâ”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”‚ User â”‚     â”‚   API   â”‚     â”‚ Redis â”‚
â””â”€â”€â”€â”¬â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”˜
    â”‚             â”‚              â”‚
    â”‚ 1. POST /auth/refresh      â”‚
    â”‚ {refresh_token}            â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚
    â”‚             â”‚              â”‚
    â”‚             â”‚ 2. Verify JWT signature
    â”‚             â”‚              â”‚
    â”‚             â”‚ 3. Check token exists
    â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚             â”‚              â”‚
    â”‚             â”‚ 4. Token validâ”‚
    â”‚             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚             â”‚              â”‚
    â”‚             â”‚ 5. Generate new access_token
    â”‚             â”‚              â”‚
    â”‚ 6. 200 OK   â”‚              â”‚
    â”‚ {access_token}             â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
```

### JWT Payload

```json
{
  "sub": "user-uuid",
  "email": "user@example.com",
  "role": "teacher",
  "school_id": "school-uuid",
  "exp": 1704067200,
  "iat": 1704066300
}
```

---

## 5. EliminaciÃ³n de Material

### Diagrama de Secuencia

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Teacher â”‚     â”‚ api-mobileâ”‚     â”‚ PostgreSQL â”‚     â”‚ RabbitMQ â”‚     â”‚ Worker â”‚     â”‚  AWS S3 â”‚     â”‚ MongoDB â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                â”‚                  â”‚                â”‚               â”‚               â”‚               â”‚
     â”‚ 1. DELETE /materials/:id          â”‚                â”‚               â”‚               â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚                â”‚               â”‚               â”‚               â”‚
     â”‚                â”‚                  â”‚                â”‚               â”‚               â”‚               â”‚
     â”‚                â”‚ 2. Verify ownership (teacher_id = current_user)   â”‚               â”‚               â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚               â”‚               â”‚               â”‚
     â”‚                â”‚                  â”‚                â”‚               â”‚               â”‚               â”‚
     â”‚                â”‚ 3. Soft delete (UPDATE deleted_at = NOW())        â”‚               â”‚               â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚               â”‚               â”‚               â”‚
     â”‚                â”‚                  â”‚                â”‚               â”‚               â”‚               â”‚
     â”‚                â”‚ 4. Publish 'material.deleted'     â”‚               â”‚               â”‚               â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚               â”‚               â”‚               â”‚
     â”‚                â”‚                  â”‚                â”‚               â”‚               â”‚               â”‚
     â”‚ 5. 204 No Content                 â”‚                â”‚               â”‚               â”‚               â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚                â”‚               â”‚               â”‚               â”‚
     â”‚                â”‚                  â”‚                â”‚               â”‚               â”‚               â”‚
     â”‚                â”‚                  â”‚ 6. Consume event               â”‚               â”‚               â”‚
     â”‚                â”‚                  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚               â”‚
     â”‚                â”‚                  â”‚                â”‚               â”‚               â”‚               â”‚
     â”‚                â”‚                  â”‚                â”‚               â”‚ 7. Delete file from S3        â”‚
     â”‚                â”‚                  â”‚                â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚               â”‚
     â”‚                â”‚                  â”‚                â”‚               â”‚               â”‚               â”‚
     â”‚                â”‚                  â”‚                â”‚               â”‚ 8. Delete MongoDB documents   â”‚
     â”‚                â”‚                  â”‚                â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                â”‚                  â”‚                â”‚               â”‚               â”‚               â”‚
     â”‚                â”‚                  â”‚                â”‚               â”‚ 9. Log deletion event         â”‚
     â”‚                â”‚                  â”‚                â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
```

### Cascada de EliminaciÃ³n

```
Material (soft delete)
    â”‚
    â”œâ”€â”€ S3 File (hard delete)
    â”‚
    â”œâ”€â”€ MongoDB: material_assessment_worker (hard delete)
    â”‚
    â”œâ”€â”€ MongoDB: material_summary (hard delete)
    â”‚
    â””â”€â”€ PostgreSQL: assessment (soft delete)
            â”‚
            â””â”€â”€ assessment_attempt (se mantiene para historial)
```

---

## ğŸ“Š Resumen de Flujos de Datos

### Escrituras por Proceso

| Proceso | PostgreSQL | MongoDB | S3 | RabbitMQ |
|---------|------------|---------|----|---------| 
| Subida Material | 2 INSERTs | 3 INSERTs | 1 PUT | 2 eventos |
| Toma Assessment | 1+N INSERTs, 1 UPDATE | - | - | - |
| MatrÃ­cula | 1 INSERT | - | - | 1 evento |
| Login | - | - | - | - |
| Eliminar Material | 2 UPDATEs | 3 DELETEs | 1 DELETE | 1 evento |

### Latencias Esperadas

| OperaciÃ³n | Latencia TÃ­pica |
|-----------|-----------------|
| Subida de material (sin procesamiento) | 2-5s |
| Procesamiento IA (worker) | 30-60s |
| Toma de assessment (por pregunta) | <100ms |
| Login | <200ms |
| Queries de listado | <500ms |

---

**Ãšltima actualizaciÃ³n:** Diciembre 2024
